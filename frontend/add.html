<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Add New Bin - Smart Waste Management System</title>
        <link rel="stylesheet" href="styles.css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <meta
            name="description"
            content="Add a new waste bin to help your community"
        />
        <meta
            name="keywords"
            content="add bin, waste management, community, location"
        />
    </head>
    <body class="add-bin-mode">
        <!-- Immediate function definitions to prevent reference errors -->
        <script>
            // Define useCurrentLocation function immediately
            window.useCurrentLocation = function () {
                console.log("Using current location - immediate function");

                if (!navigator.geolocation) {
                    const alert = document.createElement("div");
                    alert.textContent =
                        "Geolocation is not supported by your browser";
                    alert.style.cssText =
                        "position:fixed;top:80px;right:20px;background:#fadbd8;color:#721c24;padding:10px 20px;border-radius:8px;z-index:10000;cursor:pointer;";
                    alert.onclick = () => alert.remove();
                    document.body.appendChild(alert);
                    setTimeout(() => alert.remove(), 3000);
                    return;
                }

                const loadingAlert = document.createElement("div");
                loadingAlert.textContent = "Getting your location...";
                loadingAlert.style.cssText =
                    "position:fixed;top:80px;right:20px;background:#d6eaf8;color:#0c5460;padding:10px 20px;border-radius:8px;z-index:10000;";
                document.body.appendChild(loadingAlert);

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        loadingAlert.remove();
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // Update form inputs
                        const latInput = document.getElementById("latitude");
                        const lngInput = document.getElementById("longitude");
                        if (latInput) latInput.value = location.lat.toFixed(6);
                        if (lngInput) lngInput.value = location.lng.toFixed(6);

                        // Set global variable
                        window.selectedLocation = location;

                        // Center map if available
                        if (window.map) {
                            window.map.setView(
                                [location.lat, location.lng],
                                16,
                            );
                        }

                        const alert = document.createElement("div");
                        alert.textContent = "Current location selected! 📍";
                        alert.style.cssText =
                            "position:fixed;top:80px;right:20px;background:#d5f4e6;color:#1e7e34;padding:10px 20px;border-radius:8px;z-index:10000;cursor:pointer;";
                        alert.onclick = () => alert.remove();
                        document.body.appendChild(alert);
                        setTimeout(() => alert.remove(), 3000);

                        // Trigger form validation
                        const form = document.getElementById("add-bin-form");
                        if (form) {
                            form.dispatchEvent(new Event("input"));
                        }
                    },
                    (error) => {
                        loadingAlert.remove();
                        let message = "Location error: ";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message += "Permission denied";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += "Position unavailable";
                                break;
                            case error.TIMEOUT:
                                message += "Request timeout";
                                break;
                            default:
                                message += "Unknown error";
                                break;
                        }
                        const alert = document.createElement("div");
                        alert.textContent = message;
                        alert.style.cssText =
                            "position:fixed;top:80px;right:20px;background:#fadbd8;color:#721c24;padding:10px 20px;border-radius:8px;z-index:10000;cursor:pointer;";
                        alert.onclick = () => alert.remove();
                        document.body.appendChild(alert);
                        setTimeout(() => alert.remove(), 3000);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000,
                    },
                );
            };
        </script>

        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="container nav-container">
                <a href="index.html" class="nav-logo">
                    <i class="fas fa-recycle"></i> Smart Waste Management
                </a>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="find.html" class="nav-link">Find Bins</a>
                    <a
                        href="add.html"
                        class="nav-link"
                        style="background-color: rgba(255, 255, 255, 0.2)"
                        >Add Bin</a
                    >
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container main-content">
            <!-- Page Header -->
            <div class="card fade-in">
                <div class="card-header">
                    <h1><i class="fas fa-plus"></i> Add New Bin</h1>
                    <p style="color: #666; margin: 0">
                        Help your community by adding a new waste bin to our
                        shared map
                    </p>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card fade-in">
                <div class="card-body">
                    <div class="alert alert-info">
                        <h4>
                            <i class="fas fa-info-circle"></i> How to Add a Bin
                        </h4>
                        <ol style="margin: 1rem 0 0 1.5rem; padding: 0">
                            <li>
                                Click the "Use Current Location" button to
                                automatically detect your location, or
                            </li>
                            <li>
                                Click anywhere on the map to select a specific
                                location
                            </li>
                            <li>
                                Choose the current status of the bin (Empty,
                                Half-Full, or Full)
                            </li>
                            <li>
                                Click "Add Bin" to save it to the community map
                            </li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Add Bin Form -->
            <div class="card card-large fade-in">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-map-marker-alt"></i> Bin Location &
                        Details
                    </h2>
                </div>
                <div class="card-body">
                    <form id="add-bin-form" onsubmit="handleAddBin(event)">
                        <!-- Location Selection -->
                        <div
                            style="
                                display: grid;
                                grid-template-columns: 1fr auto;
                                gap: 1rem;
                                margin-bottom: 2rem;
                            "
                        >
                            <div>
                                <div class="form-group">
                                    <label for="latitude" class="form-label">
                                        <i class="fas fa-location-arrow"></i>
                                        Latitude
                                    </label>
                                    <input
                                        type="number"
                                        id="latitude"
                                        name="latitude"
                                        class="form-control"
                                        step="any"
                                        placeholder="Click on map or use current location"
                                        readonly
                                        required
                                    />
                                </div>
                                <div class="form-group">
                                    <label for="longitude" class="form-label">
                                        <i class="fas fa-location-arrow"></i>
                                        Longitude
                                    </label>
                                    <input
                                        type="number"
                                        id="longitude"
                                        name="longitude"
                                        class="form-control"
                                        step="any"
                                        placeholder="Click on map or use current location"
                                        readonly
                                        required
                                    />
                                </div>
                            </div>
                            <div style="display: flex; align-items: center">
                                <button
                                    type="button"
                                    id="current-location-btn"
                                    class="btn btn-primary"
                                    onclick="useCurrentLocation()"
                                    style="
                                        height: fit-content;
                                        white-space: nowrap;
                                    "
                                >
                                    <i class="fas fa-crosshairs"></i> Use
                                    Current Location
                                </button>
                            </div>
                        </div>

                        <!-- Bin Status Selection -->
                        <div class="form-group">
                            <label for="status" class="form-label">
                                <i class="fas fa-traffic-light"></i> Bin Status
                            </label>
                            <select
                                id="status"
                                name="status"
                                class="form-control form-select"
                                required
                            >
                                <option value="">Select bin status...</option>
                                <option value="Empty">
                                    🟢 Empty - Bin is completely empty
                                </option>
                                <option value="Half-Full">
                                    🟡 Half-Full - Bin is partially filled
                                </option>
                                <option value="Full">
                                    🔴 Full - Bin is completely full
                                </option>
                            </select>
                            <small
                                style="
                                    color: #666;
                                    font-size: 0.9rem;
                                    margin-top: 0.5rem;
                                    display: block;
                                "
                            >
                                Please select the current status of the bin to
                                help other users.
                            </small>
                        </div>

                        <!-- Submit Button -->
                        <div style="text-align: center; margin-top: 2rem">
                            <button
                                type="submit"
                                class="btn btn-success btn-large"
                            >
                                <i class="fas fa-plus"></i> Add Bin to Map
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Map Container -->
            <div class="card card-full fade-in">
                <div class="card-header">
                    <h3><i class="fas fa-map"></i> Select Location on Map</h3>
                    <p style="margin: 0; color: #666">
                        Click anywhere on the map to select the exact location
                        of the bin
                    </p>
                </div>
                <div class="card-body" style="padding: 0">
                    <div
                        id="map-container"
                        class="map-container map-fullscreen"
                    >
                        <div class="map-loading">
                            <div>
                                <i
                                    class="fas fa-map-marker-alt"
                                    style="
                                        font-size: 3rem;
                                        color: #27ae60;
                                        margin-bottom: 1rem;
                                    "
                                ></i>
                                <p>Loading map...</p>
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Instructions -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-question-circle"></i> Map Instructions
                    </h3>
                </div>
                <div class="card-body">
                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(
                                auto-fit,
                                minmax(250px, 1fr)
                            );
                            gap: 1.5rem;
                        "
                    >
                        <div>
                            <h4 style="color: #27ae60; margin-bottom: 0.5rem">
                                <i class="fas fa-mouse-pointer"></i> Click to
                                Select
                            </h4>
                            <p>
                                Click anywhere on the map to place a red marker
                                at that location. The coordinates will
                                automatically fill in the form fields above.
                            </p>
                        </div>
                        <div>
                            <h4 style="color: #3498db; margin-bottom: 0.5rem">
                                <i class="fas fa-crosshairs"></i> Use GPS
                                Location
                            </h4>
                            <p>
                                Click "Use Current Location" to automatically
                                detect your position using your device's GPS.
                                This is the most accurate method.
                            </p>
                        </div>
                        <div>
                            <h4 style="color: #f39c12; margin-bottom: 0.5rem">
                                <i class="fas fa-search-plus"></i> Zoom & Pan
                            </h4>
                            <p>
                                Use the map controls to zoom in/out and pan
                                around to find the exact location where you want
                                to place the bin.
                            </p>
                        </div>
                    </div>

                    <div
                        style="
                            margin-top: 1.5rem;
                            padding-top: 1.5rem;
                            border-top: 1px solid #eee;
                        "
                    >
                        <h4 style="color: #e74c3c; margin-bottom: 1rem">
                            <i class="fas fa-exclamation-triangle"></i>
                            Important Notes
                        </h4>
                        <ul style="color: #666; line-height: 1.8">
                            <li>
                                <strong>Accuracy:</strong> Please be as accurate
                                as possible when selecting the bin location to
                                help other users find it easily.
                            </li>
                            <li>
                                <strong>Status:</strong> Choose the current
                                status of the bin honestly to help the community
                                make better decisions.
                            </li>
                            <li>
                                <strong>Verification:</strong> Other users can
                                update the bin status, so don't worry if it
                                changes over time.
                            </li>
                            <li>
                                <strong>Duplicates:</strong> Please check the
                                map first to make sure a bin at this location
                                doesn't already exist.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card text-center fade-in">
                <div class="card-body">
                    <h3 style="color: #27ae60; margin-bottom: 1rem">
                        Need Help?
                    </h3>
                    <div
                        style="
                            display: flex;
                            gap: 1rem;
                            justify-content: center;
                            flex-wrap: wrap;
                        "
                    >
                        <a href="find.html" class="btn btn-secondary">
                            <i class="fas fa-search"></i> View Existing Bins
                        </a>
                        <a href="index.html" class="btn btn-primary">
                            <i class="fas fa-home"></i> Back to Home
                        </a>
                        <button class="btn btn-warning" onclick="resetForm()">
                            <i class="fas fa-undo"></i> Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>
                    &copy; 2024 Smart Waste Management System. Making
                    communities cleaner, one bin at a time.
                </p>
            </div>
        </footer>

        <!-- Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="env-config.js"></script>
        <script src="mobile-fixes.js"></script>
        <script src="script.js"></script>

        <!-- Initialize functions immediately -->
        <script>
            // Make functions available immediately
            function showAlert(message, type) {
                console.log(`${type.toUpperCase()}: ${message}`);
                const alertDiv = document.createElement("div");
                alertDiv.textContent = message;
                alertDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 10000;
                padding: 12px 20px;
                margin: 5px;
                border-radius: 8px;
                max-width: 350px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                cursor: pointer;
            `;

                if (type === "success") {
                    alertDiv.style.backgroundColor = "#d5f4e6";
                    alertDiv.style.color = "#1e7e34";
                    alertDiv.style.border = "1px solid #27ae60";
                } else if (type === "error") {
                    alertDiv.style.backgroundColor = "#fadbd8";
                    alertDiv.style.color = "#721c24";
                    alertDiv.style.border = "1px solid #e74c3c";
                } else if (type === "warning") {
                    alertDiv.style.backgroundColor = "#fef5e7";
                    alertDiv.style.color = "#856404";
                    alertDiv.style.border = "1px solid #f39c12";
                } else {
                    alertDiv.style.backgroundColor = "#d6eaf8";
                    alertDiv.style.color = "#0c5460";
                    alertDiv.style.border = "1px solid #3498db";
                }

                alertDiv.onclick = () => alertDiv.remove();
                document.body.appendChild(alertDiv);
                setTimeout(() => {
                    if (alertDiv.parentNode) alertDiv.remove();
                }, 5000);
            }

            // Use current location function available immediately
            function useCurrentLocationBackup() {
                console.log("Using current location...");

                if (!navigator.geolocation) {
                    showAlert(
                        "Geolocation is not supported by your browser",
                        "error",
                    );
                    return;
                }

                showAlert("Getting your location...", "info");

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        console.log("Location obtained:", location);

                        // Update form inputs
                        const latInput = document.getElementById("latitude");
                        const lngInput = document.getElementById("longitude");
                        if (latInput) latInput.value = location.lat.toFixed(6);
                        if (lngInput) lngInput.value = location.lng.toFixed(6);

                        // Update global selected location
                        window.selectedLocation = location;

                        // Center map if available
                        if (window.map) {
                            window.map.setView(
                                [location.lat, location.lng],
                                16,
                            );

                            // Add temp marker if function is available
                            if (window.map.eachLayer) {
                                // Remove existing temp markers
                                window.map.eachLayer(function (layer) {
                                    if (layer.options && layer.options.temp) {
                                        window.map.removeLayer(layer);
                                    }
                                });

                                // Add new temp marker
                                if (window.L) {
                                    const tempMarker = L.marker(
                                        [location.lat, location.lng],
                                        {
                                            temp: true,
                                            icon: L.divIcon({
                                                className: "temp-marker",
                                                html: `<div style="
                                            background: #ff6b6b;
                                            width: 25px;
                                            height: 25px;
                                            border-radius: 50%;
                                            border: 3px solid white;
                                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-weight: bold;
                                        ">📍</div>`,
                                                iconSize: [25, 25],
                                                iconAnchor: [12, 12],
                                            }),
                                        },
                                    ).addTo(window.map);

                                    tempMarker.bindPopup(
                                        "📍 Selected Location (Your Current Location)",
                                    );
                                }
                            }
                        }

                        showAlert("Current location selected! 📍", "success");

                        // Trigger form validation
                        const form = document.getElementById("add-bin-form");
                        if (form) {
                            form.dispatchEvent(new Event("input"));
                        }
                    },
                    (error) => {
                        let message = "Failed to get location: ";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message +=
                                    "Permission denied. Please allow location access.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message +=
                                    "Position unavailable. Check your connection.";
                                break;
                            case error.TIMEOUT:
                                message += "Request timeout. Please try again.";
                                break;
                            default:
                                message += "Unknown error occurred.";
                                break;
                        }
                        showAlert(message, "error");
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000,
                    },
                );
            }

            // Reset form function
            function resetForm() {
                console.log("Resetting form...");
                const form = document.getElementById("add-bin-form");
                if (form) {
                    form.reset();
                }

                const latInput = document.getElementById("latitude");
                const lngInput = document.getElementById("longitude");
                if (latInput) latInput.value = "";
                if (lngInput) lngInput.value = "";

                window.selectedLocation = null;

                // Clear temp markers
                if (window.map && window.map.eachLayer) {
                    window.map.eachLayer(function (layer) {
                        if (layer.options && layer.options.temp) {
                            window.map.removeLayer(layer);
                        }
                    });
                }

                showAlert("Form reset successfully", "info");
            }

            // Make functions globally available immediately
            window.showAlert = showAlert;
            window.useCurrentLocationBackup = useCurrentLocationBackup;
            window.resetForm = resetForm;

            console.log("Add page functions loaded and ready!");
        </script>

        <!-- Page-specific JavaScript -->
        <script>
            // Helper functions that need to be available before the main script loads
            function showAlert(message, type) {
                console.log(`${type.toUpperCase()}: ${message}`);
                // Create simple alert if the main function isn't available yet
                if (!window.smartWasteApp) {
                    const alertDiv = document.createElement("div");
                    alertDiv.className = `alert alert-${type}`;
                    alertDiv.textContent = message;
                    alertDiv.style.cssText =
                        "position: fixed; top: 80px; right: 20px; z-index: 10000; padding: 10px; margin: 5px; border-radius: 5px; max-width: 300px;";

                    if (type === "success")
                        alertDiv.style.backgroundColor = "#d5f4e6";
                    else if (type === "error")
                        alertDiv.style.backgroundColor = "#fadbd8";
                    else if (type === "warning")
                        alertDiv.style.backgroundColor = "#fef5e7";
                    else alertDiv.style.backgroundColor = "#d6eaf8";

                    document.body.appendChild(alertDiv);
                    setTimeout(() => alertDiv.remove(), 5000);
                }
            }

            function showLoading(containerId) {
                const container = document.getElementById(containerId);
                if (container && !container.querySelector(".loading-spinner")) {
                    const spinner = document.createElement("div");
                    spinner.className = "loading-spinner";
                    container.appendChild(spinner);
                }
            }

            function hideLoading(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    const spinner = container.querySelector(".loading-spinner");
                    if (spinner) spinner.remove();
                }
            }

            // Reset form function
            function resetForm() {
                console.log("Resetting form...");
                const form = document.getElementById("add-bin-form");
                if (form) {
                    form.reset();
                }

                const latInput = document.getElementById("latitude");
                const lngInput = document.getElementById("longitude");
                if (latInput) latInput.value = "";
                if (lngInput) lngInput.value = "";

                window.selectedLocation = null;

                // Clear temp marker
                if (window.map) {
                    window.map.eachLayer(function (layer) {
                        if (layer.options && layer.options.temp) {
                            window.map.removeLayer(layer);
                        }
                    });
                }

                showAlert("Form reset successfully", "info");
            }

            // Use current location function (backup if main script fails)
            function useCurrentLocationBackup() {
                console.log("Using backup current location function...");
                if (!navigator.geolocation) {
                    showAlert(
                        "Geolocation is not supported by your browser",
                        "error",
                    );
                    return;
                }

                showAlert("Getting your location...", "info");

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        // Update form inputs
                        const latInput = document.getElementById("latitude");
                        const lngInput = document.getElementById("longitude");
                        if (latInput) latInput.value = location.lat.toFixed(6);
                        if (lngInput) lngInput.value = location.lng.toFixed(6);

                        // Center map if available
                        if (window.map) {
                            window.map.setView(
                                [location.lat, location.lng],
                                16,
                            );
                        }

                        window.selectedLocation = location;
                        showAlert("Current location selected!", "success");
                    },
                    (error) => {
                        let message = "Failed to get location: ";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message += "Permission denied";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += "Position unavailable";
                                break;
                            case error.TIMEOUT:
                                message += "Request timeout";
                                break;
                            default:
                                message += "Unknown error";
                                break;
                        }
                        showAlert(message, "error");
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000,
                    },
                );
            }

            // Enhanced form validation
            document
                .getElementById("add-bin-form")
                .addEventListener("input", function () {
                    const latitude = document.getElementById("latitude").value;
                    const longitude =
                        document.getElementById("longitude").value;
                    const status = document.getElementById("status").value;
                    const submitBtn = document.querySelector(
                        'button[type="submit"]',
                    );

                    if (latitude && longitude && status) {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = "1";
                        submitBtn.classList.remove("btn-disabled");
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = "0.6";
                        submitBtn.classList.add("btn-disabled");
                    }
                });

            // Enhanced form submission handler
            function handleFormSubmission(event) {
                event.preventDefault();
                console.log("Form submitted locally");

                const form = event.target;
                const formData = new FormData(form);

                const binData = {
                    latitude: parseFloat(formData.get("latitude")),
                    longitude: parseFloat(formData.get("longitude")),
                    status: formData.get("status"),
                };

                console.log("Submitting bin data:", binData);

                // Validate data
                if (
                    !binData.latitude ||
                    !binData.longitude ||
                    !binData.status
                ) {
                    showAlert(
                        "Please fill in all fields. Click on the map to select a location.",
                        "error",
                    );
                    return;
                }

                if (isNaN(binData.latitude) || isNaN(binData.longitude)) {
                    showAlert(
                        "Invalid coordinates. Please select a location on the map.",
                        "error",
                    );
                    return;
                }

                // Submit via main app if available, otherwise direct API call
                if (
                    window.smartWasteApp &&
                    typeof window.handleAddBin === "function"
                ) {
                    window.handleAddBin(event);
                } else {
                    submitBinDirectly(binData);
                }
            }

            // Direct API submission as fallback
            async function submitBinDirectly(binData) {
                try {
                    showAlert("Adding bin to the map...", "info");

                    const response = await fetch(
                        "http://localhost:5000/api/bins",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(binData),
                        },
                    );

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || "Failed to add bin");
                    }

                    showAlert("Bin added successfully! 🎉", "success");

                    // Reset form
                    resetForm();

                    // Redirect after success
                    setTimeout(() => {
                        showAlert("Redirecting to find bins page...", "info");
                        setTimeout(() => {
                            window.location.href = "find.html";
                        }, 1500);
                    }, 2000);
                } catch (error) {
                    console.error("Error adding bin:", error);
                    showAlert(`Failed to add bin: ${error.message}`, "error");
                }
            }

            // Initialize form state
            document.addEventListener("DOMContentLoaded", function () {
                console.log("Add page DOM loaded");

                const submitBtn = document.querySelector(
                    'button[type="submit"]',
                );
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = "0.6";
                    submitBtn.classList.add("btn-disabled");
                }

                // Add form submission handler
                const form = document.getElementById("add-bin-form");
                if (form) {
                    // Remove any existing handlers and add new one
                    form.removeEventListener("submit", handleFormSubmission);
                    form.addEventListener("submit", handleFormSubmission);
                    console.log("Local form submission handler attached");
                }

                // Add current location button handler
                const currentLocationBtn = document.getElementById(
                    "current-location-btn",
                );
                if (currentLocationBtn) {
                    currentLocationBtn.addEventListener("click", function () {
                        if (typeof window.useCurrentLocation === "function") {
                            window.useCurrentLocation();
                        } else {
                            useCurrentLocationBackup();
                        }
                    });
                    console.log("Current location button handler attached");
                }

                // Add helpful tooltips
                const latInput = document.getElementById("latitude");
                const lngInput = document.getElementById("longitude");
                if (latInput)
                    latInput.title =
                        "Latitude will be filled automatically when you select a location";
                if (lngInput)
                    lngInput.title =
                        "Longitude will be filled automatically when you select a location";

                // Add map click instructions
                showAlert(
                    'Click on the map to select a location, or use the "Use Current Location" button.',
                    "info",
                );
            });

            // Handle successful bin addition
            window.addEventListener("binAdded", function () {
                showAlert(
                    "Bin added successfully! Redirecting to map...",
                    "success",
                );
                setTimeout(() => {
                    window.location.href = "find.html";
                }, 2000);
            });

            // Prevent accidental page refresh when form has data
            window.addEventListener("beforeunload", function (e) {
                const form = document.getElementById("add-bin-form");
                if (!form) return;

                const latInput = form.querySelector('input[name="latitude"]');
                const statusSelect = form.querySelector(
                    'select[name="status"]',
                );

                const hasData =
                    (latInput && latInput.value) ||
                    (statusSelect && statusSelect.value);

                if (hasData) {
                    e.preventDefault();
                    e.returnValue =
                        "You have unsaved changes. Are you sure you want to leave?";
                    return e.returnValue;
                }
            });

            // Make functions globally available
            window.resetForm = resetForm;
            window.useCurrentLocationBackup = useCurrentLocationBackup;
            window.handleFormSubmission = handleFormSubmission;
        </script>
    </body>
</html>
