<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Find Nearby Bins - Smart Waste Management System</title>
        <link rel="stylesheet" href="styles.css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <meta
            name="description"
            content="Find nearby waste bins with real-time status updates"
        />
        <meta name="keywords" content="waste bins, nearby, location, map" />
    </head>
    <body class="find-page">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-brand">
                    <i class="fas fa-recycle"></i>
                    Smart Waste Management
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="find.html" class="active">Find Bins</a></li>
                    <li><a href="add.html">Add Bin</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container">
            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <span id="visible-total" class="stat-number">0</span>
                    <div class="stat-label">Visible Bins</div>
                </div>
                <div class="stat-card">
                    <span id="visible-empty" class="stat-number">0</span>
                    <div class="stat-label">Empty</div>
                </div>
                <div class="stat-card">
                    <span id="visible-half-full" class="stat-number">0</span>
                    <div class="stat-label">Half-Full</div>
                </div>
                <div class="stat-card">
                    <span id="visible-full" class="stat-number">0</span>
                    <div class="stat-label">Full</div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="filter-container">
                <div class="filter-row">
                    <span class="filter-label">
                        <i class="fas fa-filter"></i> Filter by Status:
                    </span>
                    <select id="status-filter" class="form-control" onchange="filterBins()">
                        <option value="">All Bins</option>
                        <option value="Empty">Empty 🟢</option>
                        <option value="Half-Full">Half-Full 🟡</option>
                        <option value="Full">Full 🔴</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="refreshBins()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-primary btn-small" onclick="centerOnUser()">
                        <i class="fas fa-crosshairs"></i> My Location
                    </button>
                </div>
            </div>

            <!-- Map Container -->
            <div class="card card-full fade-in">
                <div class="card-body" style="padding: 0">
                    <div id="map-container" class="map-container map-fullscreen">
                        <div class="map-loading" id="map-loading">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 400px; background: #f8f9fa; border-radius: 8px;">
                                <div style="text-align: center;">
                                    <i class="fas fa-map-marker-alt" style="font-size: 3rem; color: #27ae60; margin-bottom: 1rem;"></i>
                                    <p style="margin: 0; color: #666; margin-bottom: 1rem;">Loading map and detecting your location...</p>
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card text-center fade-in">
                <div class="card-body">
                    <h3 style="color: #27ae60; margin-bottom: 1rem">Quick Actions</h3>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap">
                        <a href="add.html" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add New Bin
                        </a>
                        <button class="btn btn-primary" onclick="refreshBins()">
                            <i class="fas fa-sync-alt"></i> Refresh Map
                        </button>
                        <button class="btn btn-secondary" onclick="shareLocation()">
                            <i class="fas fa-share"></i> Share Location
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2024 Smart Waste Management System</p>
                <p>
                    Making</p> our communities cleaner, one bin at a time.
                </p>
            </div>
        </footer>

        <!-- Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="env-config.js"></script>
        <script src="mobile-fixes.js"></script>
        <script src="debug-map.js"></script>
        <script src="script.js"></script>

        <!-- Minimal page-specific JavaScript -->
        <script>
            // Global variables for this page
            window.allBins = [];
            window.filteredBins = [];

            // Simple filter function that works with script.js
            function filterBins() {
                const statusFilter = document.getElementById("status-filter");
                if (!statusFilter) return;

                const filterValue = statusFilter.value;
                console.log("Filtering by:", filterValue);

                if (filterValue === "") {
                    window.filteredBins = window.allBins;
                } else {
                    window.filteredBins = window.allBins.filter(
                        (bin) => bin.status === filterValue
                    );
                }

                // Update stats
                updateVisibleStats(window.filteredBins);

                // Update map markers if addBinMarkers function is available
                if (typeof window.addBinMarkers === "function") {
                    window.addBinMarkers(window.filteredBins);
                } else if (typeof addBinMarkers === "function") {
                    addBinMarkers(window.filteredBins);
                }

                // Show alert if showAlert function is available
                if (typeof showAlert === "function") {
                    showAlert(`Showing ${window.filteredBins.length} bins`, "info");
                }
            }

            // Update visible statistics
            function updateVisibleStats(bins) {
                if (!bins) return;

                const stats = {
                    total: bins.length,
                    empty: bins.filter((bin) => bin.status === "Empty").length,
                    halfFull: bins.filter((bin) => bin.status === "Half-Full").length,
                    full: bins.filter((bin) => bin.status === "Full").length,
                };

                // Update DOM elements
                const elements = {
                    "visible-total": stats.total,
                    "visible-empty": stats.empty,
                    "visible-half-full": stats.halfFull,
                    "visible-full": stats.full,
                };

                for (const [id, value] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                }
            }

            // Simple placeholder functions that will be replaced by script.js
            window.refreshBins = window.refreshBins || function() {
                console.log("Refresh function not yet loaded");
            };

            window.centerOnUser = window.centerOnUser || function() {
                console.log("Center on user function not yet loaded");
            };

            window.shareLocation = window.shareLocation || function() {
                console.log("Share location function not yet loaded");
            };

            // Page initialization marker for script.js
            window.findPageReady = true;

            // Monitor map readiness
            let mapReadyCheckCount = 0;
            const mapReadyInterval = setInterval(() => {
                mapReadyCheckCount++;

                if (window.map && typeof window.map.getCenter === 'function') {
                    console.log("✅ Map is ready and operational");
                    window.removeMapLoading();
                    clearInterval(mapReadyInterval);
                } else if (mapReadyCheckCount > 50) {
                    console.log("⚠️ Map readiness timeout - forcing debug");
                    clearInterval(mapReadyInterval);
                    // Show debug button after timeout
                    setTimeout(() => {
                        const container = document.getElementById("map-container");
                        if (container && !window.map) {
                            container.innerHTML = `
                                <div style="padding: 20px; text-align: center; color: #f39c12; background: #fef9e7; border-radius: 8px;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                    <p>Map is taking longer than expected to load</p>
                                    <button onclick="window.debugMapStatus()" class="btn btn-secondary">Debug Map</button>
                                    <button onclick="location.reload()" class="btn btn-primary" style="margin-left: 10px;">Refresh Page</button>
                                </div>
                            `;
                        }
                    }, 1000);
                }
            }, 200);

            // Add debugging function
            window.debugMapStatus = function() {
                console.log("🐛 DEBUGGING MAP STATUS:");
                console.log("- Leaflet loaded:", typeof L !== "undefined");
                console.log("- Map container exists:", !!document.getElementById("map-container"));
                console.log("- window.map exists:", !!window.map);
                console.log("- CONFIG exists:", typeof CONFIG !== "undefined");

                const container = document.getElementById("map-container");
                if (container) {
                    console.log("- Container dimensions:", container.offsetWidth + "x" + container.offsetHeight);
                    console.log("- Container visible:", container.offsetWidth > 0 && container.offsetHeight > 0);
                }

                // Try manual map initialization if needed
                if (typeof L !== "undefined" && !window.map && container) {
                    console.log("🔧 Attempting manual map initialization...");
                    try {
                        // Clear loading indicator
                        const loadingDiv = document.getElementById("map-loading");
                        if (loadingDiv) {
                            loadingDiv.remove();
                        }

                        const testMap = L.map("map-container", {
                            center: [16.3163, 80.425],
                            zoom: 13
                        });
                        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                            attribution: "© OpenStreetMap contributors"
                        }).addTo(testMap);
                        window.map = testMap;
                        console.log("✅ Manual map initialization successful!");

                        // Force resize
                        setTimeout(() => testMap.invalidateSize(), 100);
                    } catch (e) {
                        console.error("❌ Manual map initialization failed:", e);
                    }
                }
            };

            // Helper function to remove loading indicator
            window.removeMapLoading = function() {
                const loadingDiv = document.getElementById("map-loading");
                if (loadingDiv) {
                    console.log("🧹 Removing map loading indicator");
                    loadingDiv.remove();
                }
            };

            // Add debug button in development
            if (window.location.hostname.includes("localhost") || window.location.hostname.includes("netlify")) {
                setTimeout(() => {
                    const debugBtn = document.createElement("button");
                    debugBtn.textContent = "🐛 Debug Map";
                    debugBtn.style.cssText = "position:fixed;top:10px;right:10px;z-index:9999;background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:4px;font-size:12px;";
                    debugBtn.onclick = window.debugMapStatus;
                    document.body.appendChild(debugBtn);
                }, 2000);
            }

            console.log("✅ Find page HTML loaded and ready for script.js initialization");

            // Fallback map initialization for deployment compatibility
            setTimeout(() => {
                if (!window.map && typeof L !== "undefined") {
                    console.log("🔄 Fallback: Script.js didn't initialize map, doing it manually");

                    const container = document.getElementById("map-container");
                    if (container) {
                        // Clear loading content
                        container.innerHTML = "";

                        try {
                            const fallbackMap = L.map("map-container", {
                                center: [16.3164, 80.4248], // Vijayawada, India
                                zoom: 13,
                                zoomControl: true,
                                attributionControl: true
                            });

                            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                                attribution: "© OpenStreetMap contributors",
                                maxZoom: 19
                            }).addTo(fallbackMap);

                            window.map = fallbackMap;
                            map = fallbackMap;

                            // Force resize after creation
                            setTimeout(() => {
                                fallbackMap.invalidateSize();
                                console.log("✅ Fallback map resized");
                            }, 100);

                            console.log("✅ Fallback map initialization successful");

                            // Try to load bins if functions are available
                            if (typeof loadBinsData === "function") {
                                loadBinsData();
                            } else if (typeof window.smartWasteApp !== "undefined" && window.smartWasteApp.loadBinsData) {
                                window.smartWasteApp.loadBinsData();
                            }

                            // Try to get user location
                            if (navigator.geolocation && typeof getCurrentLocation === "function") {
                                getCurrentLocation().then(location => {
                                    fallbackMap.setView([location.lat, location.lng], 15);

                                    // Add user marker if function is available
                                    if (typeof addUserMarker === "function") {
                                        addUserMarker(location);
                                    }

                                    // Force resize after location change
                                    setTimeout(() => {
                                        fallbackMap.invalidateSize();
                                    }, 200);
                                }).catch(err => {
                                    console.log("Location detection failed in fallback, using default");
                                });
                            }

                            // Set up resize observer for responsive behavior
                            if (window.ResizeObserver) {
                                const resizeObserver = new ResizeObserver(() => {
                                    fallbackMap.invalidateSize();
                                });
                                resizeObserver.observe(container);
                            }

                        } catch (e) {
                            console.error("❌ Fallback map initialization failed:", e);
                            container.innerHTML = `
                                <div style="padding: 20px; text-align: center; color: #e74c3c; background: #fadbd8; border-radius: 8px;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                    <p>Map failed to load. Please refresh the page.</p>
                                    <button onclick="location.reload()" class="btn btn-primary">Refresh Page</button>
                                </div>
                            `;
                        }
                    }
                }
            }, 3000); // Wait 3 seconds for main script to initialize


        </script>
    </body>
</html>
