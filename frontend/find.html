<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Find Nearby Bins - Smart Waste Management System</title>
        <link rel="stylesheet" href="styles.css" />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <meta
            name="description"
            content="Find nearby waste bins with real-time status updates"
        />
        <meta name="keywords" content="waste bins, nearby, location, map" />
    </head>
    <body>
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-brand">
                    <i class="fas fa-recycle"></i>
                    Smart Waste Management
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="find.html" class="active">Find Bins</a></li>
                    <li><a href="add.html">Add Bin</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="visible-total">0</h3>
                        <p></p>Visible Bins</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle" style="color: #27ae60"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="visible-empty">0</h3>
                        <p>Empty</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock" style="color: #f39c12"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="visible-half-full">0</h3>
                        <p>Half-Full</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-times-circle" style="color: #e74c3c"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="visible-full">0</h3>
                        <p>Full</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <label for="status-filter">Filter by Status:</label>
                    <select id="status-filter" onchange="filterBins()">
                        <option value="">All Bins</option>
                        <option value="Empty">Empty</option>
                        <option value="Half-Full">Half-Full</option>
                        <option value="Full">Full</option>
                    </select>
                </div>
                <div class="control-buttons">
                    <button
                        class="btn btn-primary"
                        onclick="refreshBins()"
                        title="Refresh bin data"
                    >
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button
                        class="btn btn-secondary"
                        onclick="centerOnUser()"
                        title="Center map on your location"
                    >
                        <i class="fas fa-location-dot"></i> My Location
                    </button>
                    <button
                        class="btn btn-info"
                        onclick="shareLocation()"
                        title="Share your location"
                    >
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                </div>
            </div>

            <!-- Map Container -->
            <div class="map-section">
                <div id="map-container" class="map-container" style="height: 500px; min-height: 500px; width: 100%; background: #f8f9fa;">
                    <div class="map-loading" style="height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                        <div style="font-size: 3rem; color: #27ae60; margin-bottom: 1rem;">üó∫Ô∏è</div>
                        <p style="margin: 0; color: #666;">Loading map...</p>
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> How to Use</h3>
                <div class="instruction-grid">
                    <div class="instruction-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>Click on any bin marker to see details and status</p>
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-route"></i>
                        <p>Click "Go Here" to get directions to the bin</p>
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-filter"></i>
                        <p>Use the filter dropdown to show specific bin types</p>
                    </div>
                    <div class="instruction-item">
                        <i class="fas fa-sync-alt"></i>
                        <p>Click refresh to get the latest bin status updates</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2024 Smart Waste Management System</p>
                <p>
                    Making</p> our communities cleaner, one bin at a time.
                </p>
            </div>
        </footer>

        <!-- Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="env-config.js"></script>
        <script src="mobile-fixes.js"></script>
        <script src="script.js"></script>

        <!-- Minimal page-specific JavaScript -->
        <script>
            // Global variables for this page
            window.allBins = [];
            window.filteredBins = [];

            // Simple filter function that works with script.js
            function filterBins() {
                const statusFilter = document.getElementById("status-filter");
                if (!statusFilter) return;

                const filterValue = statusFilter.value;
                console.log("Filtering by:", filterValue);

                if (filterValue === "") {
                    window.filteredBins = window.allBins;
                } else {
                    window.filteredBins = window.allBins.filter(
                        (bin) => bin.status === filterValue
                    );
                }

                // Update stats
                updateVisibleStats(window.filteredBins);

                // Update map markers if addBinMarkers function is available
                if (typeof window.addBinMarkers === "function") {
                    window.addBinMarkers(window.filteredBins);
                } else if (typeof addBinMarkers === "function") {
                    addBinMarkers(window.filteredBins);
                }

                // Show alert if showAlert function is available
                if (typeof showAlert === "function") {
                    showAlert(`Showing ${window.filteredBins.length} bins`, "info");
                }
            }

            // Update visible statistics
            function updateVisibleStats(bins) {
                if (!bins) return;

                const stats = {
                    total: bins.length,
                    empty: bins.filter((bin) => bin.status === "Empty").length,
                    halfFull: bins.filter((bin) => bin.status === "Half-Full").length,
                    full: bins.filter((bin) => bin.status === "Full").length,
                };

                // Update DOM elements
                const elements = {
                    "visible-total": stats.total,
                    "visible-empty": stats.empty,
                    "visible-half-full": stats.halfFull,
                    "visible-full": stats.full,
                };

                for (const [id, value] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                }
            }

            // Simple placeholder functions that will be replaced by script.js
            window.refreshBins = window.refreshBins || function() {
                console.log("Refresh function not yet loaded");
            };

            window.centerOnUser = window.centerOnUser || function() {
                console.log("Center on user function not yet loaded");
            };

            window.shareLocation = window.shareLocation || function() {
                console.log("Share location function not yet loaded");
            };

            // Page initialization marker for script.js
            window.findPageReady = true;

            // Add debugging function
            window.debugMapStatus = function() {
                console.log("üêõ DEBUGGING MAP STATUS:");
                console.log("- Leaflet loaded:", typeof L !== "undefined");
                console.log("- Map container exists:", !!document.getElementById("map-container"));
                console.log("- window.map exists:", !!window.map);
                console.log("- CONFIG exists:", typeof CONFIG !== "undefined");

                const container = document.getElementById("map-container");
                if (container) {
                    console.log("- Container dimensions:", container.offsetWidth + "x" + container.offsetHeight);
                    console.log("- Container visible:", container.offsetWidth > 0 && container.offsetHeight > 0);
                }

                // Try manual map initialization if needed
                if (typeof L !== "undefined" && !window.map && container) {
                    console.log("üîß Attempting manual map initialization...");
                    try {
                        container.innerHTML = "";
                        const testMap = L.map("map-container", {
                            center: [16.3163, 80.425],
                            zoom: 13
                        });
                        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                            attribution: "¬© OpenStreetMap contributors"
                        }).addTo(testMap);
                        window.map = testMap;
                        console.log("‚úÖ Manual map initialization successful!");

                        // Force resize
                        setTimeout(() => testMap.invalidateSize(), 100);
                    } catch (e) {
                        console.error("‚ùå Manual map initialization failed:", e);
                    }
                }
            };

            // Add debug button in development
            if (window.location.hostname.includes("localhost") || window.location.hostname.includes("netlify")) {
                setTimeout(() => {
                    const debugBtn = document.createElement("button");
                    debugBtn.textContent = "üêõ Debug Map";
                    debugBtn.style.cssText = "position:fixed;top:10px;right:10px;z-index:9999;background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:4px;font-size:12px;";
                    debugBtn.onclick = window.debugMapStatus;
                    document.body.appendChild(debugBtn);
                }, 2000);
            }

            console.log("‚úÖ Find page HTML loaded and ready for script.js initialization");
        </script>
    </body>
</html>
